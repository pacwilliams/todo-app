#cloud-config
package_update: true
packages:
  - gnupg
  - curl
  - jq
  - cron

write_files:
  - path: /usr/local/bin/mongo_backup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      source /etc/mongo-backup.env

      TIMESTAMP=$(date +%Y-%m-%d-%H-%M)
      FILE=/tmp/mongo-backup-$TIMESTAMP.gz

      az login --identity
      ADMIN_PWD=$(az keyvault secret show --vault-name odl1986716KeyVault --name mongodb-admin-pwd --query value -o tsv)
      APP_PWD=$(az keyvault secret show --vault-name odl1986716KeyVault --name mongodb-appuser-pwd --query value -o tsv)

      # Dump MongoDB
      mongodump --uri="mongodb://appuser:$${APP_PWD}@localhost:27017/go-mongodb?authSource=go-mongodb" --archive=$FILE --gzip

      # Upload to Azure Blob Storage
      az storage blob upload \
        --account-name $STORAGE_ACCOUNT \
        --container-name $CONTAINER_NAME \
        --file $FILE \
        --name backup-$TIMESTAMP.gz \
        --auth-mode login

      rm -f $FILE

  - path: /etc/mongo-backup.env
    permissions: '0600'
    content: |
      STORAGE_ACCOUNT="odl1986716"
      CONTAINER_NAME="mongodb-backups"

  - path: /etc/systemd/system/mongo-backup.service
    permissions: '0644'
    content: |
      [Unit]
      Description=MongoDB Backup Service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/mongo_backup.sh

  - path: /etc/systemd/system/mongo-backup.timer
    permissions: '0644'
    content: |
      [Unit]
      Description=Run MongoDB Backup Daily at 2AM

      [Timer]
      OnCalendar=*-*-* 02:00:00
      Persistent=true

      [Install]
      WantedBy=timers.target


runcmd:
  - |
    # Install Azure CLI
    curl -sL https://aka.ms/InstallAzureCLIDeb | bash

    az login --identity

    # Fetch secrets from Key Vault using Managed Identity
    ADMIN_PWD=$(az keyvault secret show --vault-name ${key_vault_name} --name ${admin_secret} --query value -o tsv)
    APP_PWD=$(az keyvault secret show --vault-name ${key_vault_name} --name ${app_secret} --query value -o tsv)

    # Install MongoDB
    set -e
    sudo apt-get update -y
    sudo apt-get install -y gnupg curl
    curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
    sudo apt-get update
    sudo apt-get install -y \
    mongodb-org=7.0.24 \
    mongodb-org-database=7.0.24 \
    mongodb-org-server=7.0.24 \
    mongodb-mongosh \
    mongodb-org-shell=7.0.24 \
    mongodb-org-mongos=7.0.24 \
    mongodb-org-tools=7.0.24 \
    mongodb-org-database-tools-extra=7.0.24
    echo "mongodb-org hold" | sudo dpkg --set-selections
    echo "mongodb-org-database hold" | sudo dpkg --set-selections
    echo "mongodb-org-server hold" | sudo dpkg --set-selections
    echo "mongodb-mongosh hold" | sudo dpkg --set-selections
    echo "mongodb-org-mongos hold" | sudo dpkg --set-selections
    echo "mongodb-org-tools hold" | sudo dpkg --set-selections
    echo "mongodb-org-database-tools-extra hold" | sudo dpkg --set-selections

    # Configure mongod.conf
    sudo tee /etc/mongod.conf > /dev/null <<MONGO_CONF
    storage:
      dbPath: /var/lib/mongodb
      engine: wiredTiger
    systemLog:
      destination: file
      logAppend: true
      path: /var/log/mongodb/mongod.log
    net:
      port: 27017
      bindIp: 0.0.0.0
    security:
      authorization: disabled
    MONGO_CONF

    # Start MongoDB and create users
    sudo systemctl start mongod
    sleep 15
    mongosh admin --eval "db.getSiblingDB('admin').createUser({user:'admin',pwd:'$${ADMIN_PWD}',roles:[{role:'root',db:'admin'}]})" >> /var/log/mongosh.log 2>&1
    sudo systemctl stop mongod
    sudo sed -i 's/authorization: disabled/authorization: enabled/' /etc/mongod.conf
    sudo systemctl start mongod
    sleep 15
    mongosh -u admin -p "$${ADMIN_PWD}" --authenticationDatabase admin --eval "db.getSiblingDB('go-mongodb').createUser({user:'appuser',pwd:'$${APP_PWD}',roles:[{role:'readWrite',db:'go-mongodb'}]})" >> /var/log/mongosh.log 2>&1
    sudo systemctl enable mongod

    # Enable and start backup timer
    sudo systemctl daemon-reload
    sudo systemctl enable mongo-backup.timer
    sudo systemctl start mongo-backup.timer